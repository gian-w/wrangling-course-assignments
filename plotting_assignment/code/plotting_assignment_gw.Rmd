---
title: "Plotting Assignment - "
author: "Gian Wegmueller"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: show
    highlight: haddock
    theme: flatly
    toc: yes
    toc_float: yes
---

```{r, include=FALSE}

# set knit options
knitr::opts_chunk$set(message = FALSE,
                      warning = FALSE)

# disable scientific notation
options(scipen = 999) 


```

# Dependencies

```{r}

# update dependencies -> only include necessary packages

library(readr)
library(dplyr)
library(tidyr)
library(janitor)
library(stringr)
library(trackeR)
library(leaflet)
library(tmap)
library(ggplot2)


library(datasauRus) 
library(scales)

library(plotrix) 
library(ThemePark)
library(patchwork)

library(knitr)
library(kableExtra)

```


# Data exploration (temporary, should not be included in final file)

```{r Data exploration}
## Drug use data
drugs_raw <- read_csv("../data/drug_use_by_age.csv")


```

## Data Preparation Drug Use

```{r Data prep}
drugs_comparison <- drugs_raw %>% 
  select(age, n, 
         starts_with(c("alcohol", "marijuana", "cocaine", "meth"))) %>% 
  filter(age %in% c("21", "22-23", "24-25", "26-29", "50-64")) %>% #choosing only legal drinking-age millenials for comparison here!
  mutate(cocaine_frequency = as.numeric(cocaine_frequency),
         meth_frequency = as.numeric(meth_frequency),
         generation = if_else(age == "50-64", "Boomers", "Millennials")) %>% 
  group_by(generation) %>% 
  summarize(booze_med_freq = janitor::round_half_up(weighted.mean(alcohol_frequency, n), 1),
            pot_med_freq = janitor::round_half_up(weighted.mean(marijuana_frequency, n), 1),
            coke_med_freq = janitor::round_half_up(weighted.mean(cocaine_frequency, n), 1),
            meth_med_freq = janitor::round_half_up(weighted.mean(meth_frequency, n), 1)) %>% 
  pivot_longer(cols = booze_med_freq:meth_med_freq,
               names_to = "drug",
               values_to = "median_freq")

```

## Data Visualization Median Use Frequency

```{r Visualization}

# Bad plot for visualizing median use frequency of 4 different drugs by generation (Boomers & Millennials)
drug_use_plot <- ggplot(data = drugs_comparison,
                 aes(x = median_freq,
                     y = drug,
                     colour = generation)) +
  
  geom_bin_2d(position = "stack", 
              binwidth = 5,
              fill = "#FF5F1F",
              show.legend = TRUE) +
  
  geom_line(mapping = aes(group = generation),
            linewidth = .2) +
  
  scale_colour_manual(values = c("#00BFFF", "#00827F")) + 
  
  scale_x_continuous(breaks = seq(0, 60, 2.3),
                     limits = c(0, 60)) +
  
  labs(title = "Median Use Frequency by Generation",
       x = "Median Use Frequency", 
       y = "",
       colour = "Generation") +
  
  theme_dark(base_family = "serif")
  

drug_use_plot
```

# Visualizing Heart Rate Data from the Lucerne Half-Marathon 2024

## Data Preparation Lucerne Half-Marathon
My heart rate zones at the time of the race were: 

- Zone 1: 98 - 116 bpm
- Zone 2: 117 - 136 bpm
- Zone 3: 137 - 155 bpm
- Zone 4: 156 - 175 bpm
- Zone 5: >= 176 bpm

These data were extracted from my personal Garmin Connect account. 



```{r data prep lucerne half}
# loading the data (requires readTCX-function from package trackeR)
lucerne_half_24 <- readTCX("../data/lucerne_half_2024.tcx")

# creating subset with variables of interest
lucerne_half_24_bpm <- lucerne_half_24 %>% 
  select(latitude, longitude, altitude, distance, heart_rate) %>% # selecting variables of interest
  mutate(distance_km = distance/1000, # creating distance_km variable by dividing 'distance' by 1000, because the latter is specified in metres
         heart_rate_zone = as.factor(case_when(heart_rate >= 137 & heart_rate <= 155 ~ "Zone 3", # creating heart_rate_zone variable according to data provided on Garmin Connect
                                               heart_rate >= 156 & heart_rate <= 175 ~ "Zone 4",
                                               heart_rate >= 176 ~ "Zone 5")),
         
         zone_min = case_when(heart_rate_zone == "Zone 3" ~ 137,
                              heart_rate_zone == "Zone 4" ~ 156,
                              heart_rate_zone == "Zone 5" ~ 176),
         
         zone_max = case_when(heart_rate_zone == "Zone 3" ~ 156,
                              heart_rate_zone == "Zone 4" ~ 176,
                              heart_rate_zone == "Zone 5" ~ 190)) %>% 
  relocate(latitude, longitude, distance_km, distance, altitude, heart_rate, heart_rate_zone, zone_min, zone_max) # reorder columns in data frame

```


## Visualization of Heart Rate During Lucerne Half-Marathon

```{r data visualiziation lucerne half}
heart_rate_plot <- ggplot(data = lucerne_half_24_bpm,
                          aes(x = distance_km,
                              y = heart_rate)) +
  scale_x_continuous(breaks = seq(0, max(lucerne_half_24_bpm$distance_km), 1), 
                     limits = c(0, max(lucerne_half_24_bpm$distance_km))) +
  scale_y_continuous(breaks = seq(140, 190, 5),
                     limits = c(140, 190)) +
  geom_smooth(method = "loess",
              span = .003,
              linewidth = .7) +
  geom_rect(aes(xmin = 0, xmax = max(lucerne_half_24_bpm$distance_km), ymin = 176, ymax = 190),
            fill = "red") +
  geom_rect(aes(xmin = 0, xmax = max(lucerne_half_24_bpm$distance_km), ymin = 156, ymax = 175),
            fill = "orange") +
  geom_rect(aes(xmin = 0, xmax = max(lucerne_half_24_bpm$distance_km), ymin = 140, ymax = 155),
            fill = "green")


heart_rate_plot

## better version here (less code)

ggplot(data = lucerne_half_24_bpm,
                          aes(x = distance_km,
                              y = heart_rate)) +
  scale_x_continuous(breaks = seq(0, max(lucerne_half_24_bpm$distance_km), 1), 
                     limits = c(0, max(lucerne_half_24_bpm$distance_km))) +
  scale_y_continuous(breaks = seq(140, 190, 5),
                     limits = c(137, 190)) +
  
    geom_rect(data = lucerne_half_24_bpm,
            aes(xmin = 0, xmax = max(distance_km),
                ymin = zone_min, ymax = zone_max,
                fill = heart_rate_zone),
            alpha = 0.1) +
  
  scale_fill_viridis_d(option = "turbo",
                       begin = .5,
                       end = .8,
                       guide = guide_legend(title = "Heart Rate Zones",
                                            reverse = TRUE,
                                            override.aes = list(alpha = 0.8))) +
  
  geom_smooth(method = "loess",
              span = .003,
              linewidth = .7,
              colour = "black")

## ChatGPT recommended colours for Zone 3-5
"#CAF2C2"
"#FFF8B8"
"#FFD6C9"







```


## Interactive Map
```{r}
# Create hr_colour vector
hr_colour <- viridis_pal(option = "turbo", begin = 0.5, end = 0.8)(3)

## Add colour variable to dataset for easier mapping
lucerne_half_24_bpm <- lucerne_half_24_bpm %>% 
  mutate(hrz_colour = case_when(heart_rate_zone == "Zone 3" ~ hr_colour[1],
                                heart_rate_zone == "Zone 4" ~ hr_colour[2],
                                heart_rate_zone == "Zone 5" ~ hr_colour[3]))




hr_zones <- c("Zone 3", "Zone 4", "Zone 5")

names(hr_colours) <- hr_zones
hr_palette <- colorFactor(palette = hr_colours, domain = lucerne_half_24_bpm$heart_rate_zone)

## create continuous colour palette for heart rate
hr_colours_c <- viridis_pal(option = "turbo", begin = 0.5, end = 0.8)(100)
hr_palette_c <- colorNumeric(palette = hr_colours_c, domain = lucerne_half_24_bpm$heart_rate)


lucerne_half_24_sliced <- slice_sample(lucerne_half_24_bpm, prop = 0.5)

## interactive map to visualize route and hear rate zones
lucerne_half_map <- leaflet(lucerne_hel) %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addPolylines(lat = ~latitude, lng = ~longitude, color = ~hrz_colour,
               weight = 4, 
               opacity = .8) %>%
  setView(lat = 47.0300000000000, lng = 8.318685121853448, zoom = 12.5)
  


### FULL DATASET-------------------------------------------------------------- ###
## interactive map to visualize route and heart rate zones
lucerne_half_map <- leaflet(lucerne_half_24_bpm) %>% 
  addProviderTiles(providers$CartoDB.Positron) 

  # Loop through the data and add segments individually
for (i in 1:(nrow(lucerne_half_24_bpm) - 1)) {
  lucerne_half_map <- lucerne_half_map %>%   
  addPolylines(
      lng = c(lucerne_half_24_bpm$longitude[i], lucerne_half_24_bpm$longitude[i + 1]),
      lat = c(lucerne_half_24_bpm$latitude[i], lucerne_half_24_bpm$latitude[i + 1]),
      color = hr_palette(lucerne_half_24_bpm$heart_rate_zone[i]),  # Color by heart rate
      weight = 4,
      opacity = 0.8
    )
}
  

### SLICED DATASET------------------------------------------------------------###
lucerne_half_24_sliced <- lucerne_half_24_bpm %>% 
  slice(seq(1, n(), 2))


## interactive map to visualize route and heart rate zones
lucerne_half_map <- leaflet(lucerne_half_24_sliced) %>% 
  addProviderTiles(providers$CartoDB.Positron) 

  # Loop through the data and add segments individually
for (i in 1:(nrow(lucerne_half_24_sliced) - 1)) {
  lucerne_half_map <- lucerne_half_map %>%   
  addPolylines(
      lng = c(lucerne_half_24_sliced$longitude[i], lucerne_half_24_sliced$longitude[i + 1]),
      lat = c(lucerne_half_24_sliced$latitude[i], lucerne_half_24_sliced$latitude[i + 1]),
      color = hr_palette(lucerne_half_24_sliced$heart_rate_zone[i]),  # Color by heart rate
      weight = 4,
      opacity = 0.8
    )
}


lucerne_half_map <- lucerne_half_map %>% 
  setView(lat = 47.0300000000000, lng = 8.318685121853448, zoom = 12.5)

lucerne_half_map

 

addPolylines(lat = ~latitude, lng = ~longitude, color = ~hr_palette_c(lucerne_half_24_bpm$heart_rate),
               weight = 4, 
               opacity = .8) %>% 
  

#TODO
# add start and finish line symbols to route
# add value based colouring
# add zoom for default view

```


# Session info

```{r}

sessionInfo()

```
